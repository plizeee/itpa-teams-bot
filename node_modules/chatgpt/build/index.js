var k=Object.create;var w=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,T=Object.prototype.hasOwnProperty;var D=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var B=(s,e,r,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of C(e))!T.call(s,t)&&t!==r&&w(s,t,{get:()=>e[t],enumerable:!(a=v(e,t))||a.enumerable});return s};var L=(s,e,r)=>(r=s!=null?k(M(s)):{},B(e||!s||!s.__esModule?w(r,"default",{value:s,enumerable:!0}):r,s));var x=D((A,l)=>{"use strict";var E=(s,e)=>Math.floor(Math.random()*(e-s+1)+s),_=()=>{let s=new Error("Delay aborted");return s.name="AbortError",s},b=({clearTimeout:s,setTimeout:e,willResolve:r})=>(a,{value:t,signal:o}={})=>{if(o&&o.aborted)return Promise.reject(_());let i,n,m,g=s||clearTimeout,u=()=>{g(i),m(_())},P=()=>{o&&o.removeEventListener("abort",u)},p=new Promise((I,d)=>{n=()=>{P(),r?I(t):d(t)},m=d,i=(e||setTimeout)(n,a)});return o&&o.addEventListener("abort",u,{once:!0}),p.clear=()=>{g(i),i=null,n()},p},f=s=>{let e=b({...s,willResolve:!0});return e.reject=b({...s,willResolve:!1}),e.range=(r,a,t)=>e(E(r,a),t),e},c=f();c.createWithTimers=f;l.exports=c;l.exports.default=c});var h=L(x(),1);import $ from"html-to-md";import{chromium as U}from"playwright";var y=class{constructor(e={}){let{userDataDir:r="/tmp/chatgpt",chatUrl:a="https://chat.openai.com/",headless:t=!1,markdown:o=!0}=e;this._userDataDir=r,this._headless=!!t,this._chatUrl=a,this._markdown=!!o}async init(e={}){let{auth:r="eager"}=e;this._browser&&await this.close(),this._browser=await U.launchPersistentContext(this._userDataDir,{headless:this._headless}),this._page=await this._browser.newPage(),await this._page.goto(this._chatUrl);do{let a='[data-headlessui-state="open"]';if(!await this._page.$(a))break;try{await this._page.click(`${a} button:last-child`,{timeout:1e3})}catch{break}}while(!0);if(r==="blocking")do{if(await this.getIsSignedIn())break;console.log("Please sign in to ChatGPT using the Chromium browser window and dismiss the welcome modal..."),await(0,h.default)(1e3)}while(!0);return this._page}async getIsSignedIn(){try{return!!await this._getInputBox()}catch{return!1}}async getLastMessage(){let e=await this.getMessages();return e?e[e.length-1]:null}async getPrompts(){let e=await this._page.$$('[class*="ConversationItem__Message"]:has([class*="ConversationItem__ActionButtons"]):has([class*="ConversationItem__Role"] [class*="Avatar__Wrapper"])');return Promise.all(e.map(r=>r.innerText()))}async getMessages(){let e=await this._page.$$('[class*="ConversationItem__Message"]:has([class*="ConversationItem__ActionButtons"]):not(:has([class*="ConversationItem__Role"] [class*="Avatar__Wrapper"]))');return this._markdown?(await Promise.all(e.map(t=>t.innerHTML()))).map(t=>(t=t.replace("Copy code</button>","</button>"),$(t,{ignoreTags:["button","svg","style","form","noscript","script","meta","head"],skipTags:["button","svg"]}))):await Promise.all(e.map(a=>a.innerText()))}async sendMessage(e){let r=await this._getInputBox();if(!r)throw new Error("not signed in");let a=await this.getLastMessage();await r.click({force:!0}),await r.fill(e,{force:!0}),await r.press("Enter");do{await(0,h.default)(1e3);let t=await this.getLastMessage();if(t&&(a==null?void 0:a.toLowerCase())!==(t==null?void 0:t.toLowerCase()))return t}while(!0)}async close(){await this._browser.close(),this._page=null,this._browser=null}async _getInputBox(){return this._page.$('div[class*="PromptTextarea__TextareaWrapper"] textarea')}};export{y as ChatGPTAPI};
//# sourceMappingURL=index.js.map